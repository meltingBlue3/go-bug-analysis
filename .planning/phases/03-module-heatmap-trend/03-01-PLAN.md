---
phase: 03-module-heatmap-trend
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - internal/analysis/module.go
  - internal/analysis/types.go
  - internal/analysis/analyze.go
  - web/static/index.html
  - web/static/js/dashboard.js
  - web/static/css/style.css
autonomous: true

must_haves:
  truths:
    - "User sees per-module bug count breakdown (total and active) in a sortable table"
    - "User sees a Module × Severity heatmap highlighting bug concentration hotspots"
    - "User sees module bug trend lines for the last 7 and 30 days with toggle"
  artifacts:
    - path: "internal/analysis/module.go"
      provides: "Module analysis computation — stats, heatmap matrix, trend data"
      min_lines: 80
    - path: "internal/analysis/types.go"
      provides: "ModuleData, ModuleStats, HeatmapCell, TrendSeries types"
      contains: "ModuleData"
    - path: "internal/analysis/analyze.go"
      provides: "ComputeModule wired into Analyze()"
      contains: "ComputeModule"
    - path: "web/static/js/dashboard.js"
      provides: "renderModule, renderModuleTable, renderHeatmap, renderTrend functions"
      min_lines: 100
    - path: "web/static/index.html"
      provides: "Module section HTML — table, heatmap container, trend chart container"
      contains: "module-table"
  key_links:
    - from: "internal/analysis/analyze.go"
      to: "internal/analysis/module.go"
      via: "ComputeModule(bugs) call in Analyze()"
      pattern: "ComputeModule\\(bugs\\)"
    - from: "web/static/js/dashboard.js"
      to: "/api/analysis"
      via: "fetch in renderDashboard, data.module passed to renderModule"
      pattern: "renderModule\\(data\\.module\\)"
    - from: "web/static/js/dashboard.js"
      to: "echarts"
      via: "echarts.init for heatmap and line chart"
      pattern: "echarts\\.init"
---

<objective>
Implement module-level bug analysis with three views: a sortable statistics table showing per-module total/active bug counts (MOD-01), a Module × Severity ECharts heatmap visualizing bug concentration hotspots (MOD-02), and trend line charts showing module bug creation over the last 7 and 30 days (MOD-03).

Purpose: Enable users to identify which modules carry the worst bug burden and track whether quality is improving or degrading over time — the key missing dimension after KPI/severity/age/workload analysis.
Output: `internal/analysis/module.go` (backend computation), extended types/analyze, dashboard section with table + heatmap + trend charts.
</objective>

<execution_context>
@C:/Users/zhang/.config/opencode/get-shit-done/workflows/execute-plan.md
@C:/Users/zhang/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-core-kpi-bottleneck-analysis/02-01-SUMMARY.md
@.planning/phases/02-core-kpi-bottleneck-analysis/02-03-SUMMARY.md

@internal/analysis/types.go
@internal/analysis/analyze.go
@internal/analysis/dateutil.go
@internal/analysis/workload.go
@internal/csvparse/types.go
@internal/server/server.go
@web/static/index.html
@web/static/js/dashboard.js
@web/static/css/style.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Backend — Module statistics, heatmap matrix, and trend computation</name>
  <files>
    internal/analysis/module.go
    internal/analysis/types.go
    internal/analysis/analyze.go
  </files>
  <action>
**1. Add types to `types.go`:**

Add a `Module` field to `AnalysisResult`:
```go
Module *ModuleData `json:"module,omitempty"`
```

Add new types:
```go
// ModuleData holds all module-level analysis results.
type ModuleData struct {
    Stats   []ModuleStats  `json:"stats"`   // per-module total/active counts
    Heatmap *HeatmapData   `json:"heatmap"` // module × severity matrix
    Trend   *TrendData     `json:"trend"`   // daily bug creation trend
}

// ModuleStats represents bug counts for one module.
type ModuleStats struct {
    Name        string `json:"name"`
    Total       int    `json:"total"`
    Active      int    `json:"active"`
    ActiveRate  float64 `json:"activeRate"` // active/total as percentage (0-100)
}

// HeatmapData holds the Module × Severity heatmap matrix.
type HeatmapData struct {
    Modules    []string   `json:"modules"`    // Y-axis labels (module names)
    Severities []string   `json:"severities"` // X-axis labels: ["致命","严重","一般","轻微"]
    Data       [][]int    `json:"data"`       // [moduleIdx][severityIdx] = count
    MaxValue   int        `json:"maxValue"`   // max cell value for color scale
}

// TrendData holds daily bug creation counts per module.
type TrendData struct {
    Dates   []string      `json:"dates"`   // date strings "01-15", "01-16"...
    Series  []TrendSeries `json:"series"`  // one per top module
    Days7   int           `json:"days7"`   // index offset for 7-day view start
}

// TrendSeries represents one module's daily counts for trend chart.
type TrendSeries struct {
    Name   string `json:"name"`
    Counts []int  `json:"counts"` // one count per date
}
```

**2. Create `module.go`:**

Implement `ComputeModule(bugs []csvparse.Bug) *ModuleData` that orchestrates three sub-computations:

**a) `computeModuleStats`** — Single pass over bugs:
- Group by `bug.Module` field (trim whitespace). Empty module → "未分类".
- Count total and active (Status == "激活") per module.
- Compute `activeRate = float64(active) / float64(total) * 100`, round to 1 decimal using existing `roundTo` pattern (but define locally or reuse from age.go — if not exported, define a local `round1` helper).
- Sort descending by Total count; ties broken alphabetically.
- Return `[]ModuleStats`.

**b) `computeHeatmap`** — Build module × severity matrix:
- Use top 15 modules from stats (by total count) to keep heatmap readable.
- Severity columns: "1" → "致命", "2" → "严重", "3" → "一般", "4" → "轻微" (4 columns fixed).
- Single pass over bugs: for each bug, if its module is in top-15 set, increment `matrix[moduleIdx][severityIdx]`.
- Track `maxValue` across all cells for color scale normalization.
- Return `HeatmapData` with modules (top-15 names), severities labels, 2D data array, maxValue.

**c) `computeTrend`** — Daily bug creation counts per module:
- Determine date range: last 30 days from `Today()` (reuse from dateutil.go).
- Generate 30 date slots as `[]time.Time` from today-29 to today.
- Format dates as "MM-DD" strings for JSON.
- Pick top 10 modules (by total bug count from stats) for trend lines.
- Single pass over bugs: parse `CreatedDate` via `ParseDate()`, if within 30-day range AND module is in top-10 set, increment `moduleCountByDate[module][dateIdx]`.
- Build `[]TrendSeries` — one per top-10 module with `Counts` array of length 30.
- Compute `days7 = 23` (index where last-7-day window starts: 30-7=23).
- Return `TrendData`.

**3. Wire into `analyze.go`:**

Add `Module: ComputeModule(bugs),` to the `AnalysisResult` return in `Analyze()`.
  </action>
  <verify>
Run `go build ./...` and `go vet ./...` — both must pass with zero errors. Verify `internal/analysis/module.go` exists and contains `ComputeModule`, `computeModuleStats`, `computeHeatmap`, `computeTrend` functions.
  </verify>
  <done>
`/api/analysis` response includes `module` field with `stats` (per-module total/active/activeRate), `heatmap` (modules × severities matrix with maxValue), and `trend` (30-day dates, top-10 module series, days7 offset). All types properly defined in types.go.
  </done>
</task>

<task type="auto">
  <name>Task 2: Frontend — Module table, heatmap chart, and trend line chart</name>
  <files>
    web/static/index.html
    web/static/js/dashboard.js
    web/static/css/style.css
  </files>
  <action>
**1. Add module section to `index.html`** (after the workload-row div, before closing `</main>`):

```html
<!-- 模块质量分析 -->
<div class="section-divider">
    <h2 class="section-title">模块质量分析</h2>
</div>

<!-- 模块统计表 -->
<div class="data-table-card" id="module-stats-card">
    <div class="chart-header">
        <h3 class="chart-title">模块 Bug 统计</h3>
        <span class="module-count" id="module-count"></span>
    </div>
    <div class="table-scroll table-scroll-md">
        <table class="data-table sortable-table" id="module-table">
            <thead>
                <tr>
                    <th data-sort="name">模块名称</th>
                    <th data-sort="total" class="sort-active sort-desc">Bug 总数 ▼</th>
                    <th data-sort="active">激活数</th>
                    <th data-sort="rate">激活率</th>
                </tr>
            </thead>
            <tbody id="module-tbody">
                <tr><td colspan="4" class="placeholder-text">数据加载后显示</td></tr>
            </tbody>
        </table>
    </div>
</div>

<!-- 模块 × 严重程度热力图 -->
<div class="chart-row">
    <div class="chart-card chart-card-full">
        <h3 class="chart-title">模块 × 严重程度 热力图</h3>
        <div class="chart-container chart-container-dynamic" id="chart-module-heatmap"></div>
    </div>
</div>

<!-- 模块 Bug 趋势 -->
<div class="chart-row">
    <div class="chart-card chart-card-full">
        <div class="chart-header">
            <h3 class="chart-title">模块 Bug 新增趋势</h3>
            <div class="chart-controls">
                <div class="toggle-group" id="trend-range-toggle">
                    <button class="toggle-btn" data-value="7">近 7 天</button>
                    <button class="toggle-btn active" data-value="30">近 30 天</button>
                </div>
            </div>
        </div>
        <div class="chart-container chart-container-lg" id="chart-module-trend">
            <div class="placeholder-text">数据加载后显示</div>
        </div>
    </div>
</div>
```

**2. Extend `dashboard.js`** — Add module rendering functions inside the IIFE:

**Module state variables** (add near top with other chart state):
```javascript
var moduleHeatmapChart = null;
var moduleTrendChart = null;
var moduleTrendData = null;
var currentTrendRange = '30';
```

**Call `renderModule(data.module)` in `renderDashboard()`** after `renderWorkload(data.workload)`.

**`renderModule(moduleData)`** — Entry point:
- Guard: `if (!moduleData) return;`
- Call `renderModuleTable(moduleData.stats)`
- Call `renderModuleHeatmap(moduleData.heatmap)`
- Store `moduleTrendData = moduleData.trend`
- Call `renderModuleTrend(moduleData.trend)`
- Call `initTrendToggle()`

**`renderModuleTable(stats)`** — Sortable table:
- Set module count text: "共 X 个模块"
- Build table rows: module name, total, active (with danger class if active > 10), activeRate with `%` suffix (add `rate-danger` class if > 50%, `rate-warning` if > 30%).
- Implement click-to-sort on `<th>` headers: toggle asc/desc, re-sort `stats` array, rebuild tbody. Use `data-sort` attribute. Update header text with ▲/▼ indicator.
- Pattern: clone the stats array before sorting to preserve original order.

**`renderModuleHeatmap(heatmap)`** — ECharts heatmap:
- Guard: `if (!heatmap || !heatmap.modules.length) return;`
- Set container height: `Math.max(300, heatmap.modules.length * 36)px`.
- Dispose existing `moduleHeatmapChart` if exists, then `echarts.init`.
- Build ECharts heatmap option:
  - `tooltip` with formatter showing "模块: {module}, {severity}: {count}条"
  - `grid`: left 120px (module name space), right 80px, top 30px, bottom 40px
  - `xAxis`: category, data = `heatmap.severities` (["致命","严重","一般","轻微"])
  - `yAxis`: category, data = `heatmap.modules` (reversed for top-down display)
  - `visualMap`: min 0, max `heatmap.maxValue`, calculable true, orient 'vertical', right 10, inRange colors `['#f0f5ff', '#1890ff', '#003a8c']` (light blue → dark blue gradient)
  - `series`: type 'heatmap', data = flatten 2D array to `[xIdx, yIdx, value]` tuples (reverse yIdx to match reversed yAxis), label show true for cells with count > 0, emphasis with itemStyle shadowBlur
- `chart.setOption(option)` and add resize listener.

**`renderModuleTrend(trend)`** — ECharts line chart:
- Guard: `if (!trend || !trend.series.length) return;`
- Dispose existing `moduleTrendChart` if exists, then `echarts.init` on `#chart-module-trend`.
- Determine date slice: if `currentTrendRange === '7'`, slice dates from `trend.days7` and slice each series counts from `trend.days7`. Else use full 30-day data.
- Define a color palette for up to 10 lines: `['#1890ff','#ff4d4f','#faad14','#52c41a','#722ed1','#eb2f96','#13c2c2','#fa8c16','#2f54eb','#a0d911']`.
- Build ECharts line option:
  - `tooltip`: trigger 'axis'
  - `legend`: bottom 0, type 'scroll'
  - `grid`: left '3%', right '4%', bottom '15%' (space for legend), top '8%', containLabel true
  - `xAxis`: category, data = sliced dates, axisLabel rotate 30 if > 15 items
  - `yAxis`: type 'value', minInterval 1
  - `series`: for each `trend.series[i]`, type 'line', name = series.name, data = sliced counts, smooth true, symbol 'circle', symbolSize 4, lineStyle width 2, color from palette
- `chart.setOption(option, true)`.

**`initTrendToggle()`** — Toggle between 7-day and 30-day:
- Get `#trend-range-toggle`, add click event delegation (same pattern as severity toggle).
- On toggle: update `currentTrendRange`, call `renderModuleTrend(moduleTrendData)`.

**Add resize listeners** for heatmap and trend charts in the resize handler.

**3. Add CSS to `style.css`:**

```css
/* Section divider for module analysis */
.section-divider {
    margin: 2rem 0 1rem;
    padding: 0 0 0.5rem;
    border-bottom: 2px solid var(--primary);
}
.section-title {
    font-size: 1.25rem;
    font-weight: 600;
    color: var(--text);
    margin: 0;
}

/* Full-width chart card */
.chart-card-full {
    flex: 1 1 100%;
    min-width: 0;
}

/* Larger chart container for trend */
.chart-container-lg {
    min-height: 400px;
}

/* Medium table scroll (module table) */
.table-scroll-md {
    max-height: 500px;
}

/* Sortable table headers */
.sortable-table th {
    cursor: pointer;
    user-select: none;
    transition: background-color 0.2s;
}
.sortable-table th:hover {
    background-color: rgba(24, 144, 255, 0.08);
}
.sort-active {
    color: var(--primary);
}

/* Active rate styling */
.rate-danger { color: #ff4d4f; font-weight: 600; }
.rate-warning { color: #faad14; font-weight: 600; }

/* Module count badge */
.module-count {
    font-size: 0.85rem;
    color: #999;
}
```
  </action>
  <verify>
Run `go build ./...` — must pass (ensures embed picks up new HTML). Open browser to `http://localhost:18080`, upload `2225.csv`, scroll to module section. Verify:
1. Module table renders with module names, total/active counts, active rate percentages, and click-to-sort works on each column header.
2. Heatmap renders as a Module × Severity grid with blue color intensity showing bug concentration.
3. Trend chart shows line chart with multiple module lines. Toggle between 7-day and 30-day views works.
  </verify>
  <done>
Dashboard displays module analysis section with: (1) sortable module stats table showing total/active/activeRate per module, (2) Module × Severity heatmap with blue gradient color scale and tooltips, (3) line chart showing top-10 module bug creation trends with 7d/30d toggle. All three MOD requirements (MOD-01, MOD-02, MOD-03) satisfied.
  </done>
</task>

</tasks>

<verification>
After both tasks complete:
1. `go build ./...` and `go vet ./...` pass cleanly
2. `/api/analysis` JSON response contains `module.stats`, `module.heatmap`, and `module.trend` fields with correct data
3. Module stats table shows per-module breakdown, is sortable by all 4 columns
4. Heatmap correctly maps Module × Severity with color intensity proportional to bug count
5. Trend chart renders smooth line chart for top modules, 7d/30d toggle works
6. All charts responsive on window resize
7. Empty module field handled gracefully as "未分类"
</verification>

<success_criteria>
- MOD-01: Per-module total and active bug counts visible in a sortable table
- MOD-02: Module × Severity heatmap renders with visual color intensity highlighting hotspots
- MOD-03: Module bug trend lines displayed for last 7 and 30 days with toggle switch
- All existing dashboard features (KPI, severity, age, workload) unaffected
- Application compiles and runs as single binary
</success_criteria>

<output>
After completion, create `.planning/phases/03-module-heatmap-trend/03-01-SUMMARY.md`
</output>
