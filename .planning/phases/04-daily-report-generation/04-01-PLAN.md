---
phase: 04-daily-report-generation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - internal/analysis/types.go
  - internal/analysis/report.go
  - internal/analysis/analyze.go
  - web/static/index.html
  - web/static/js/dashboard.js
  - web/static/css/style.css
autonomous: true
must_haves:
  truths:
    - "After CSV import, a structured daily report appears in a dedicated section below the dashboard charts"
    - "Report contains today's new/fixed/net-change counts matching the KPI cards"
    - "Report highlights severity 1-2 bugs with long backlog (>7 days) as risk items"
    - "Report includes top bottleneck modules and top-loaded personnel"
    - "User can toggle between Markdown and plain text views of the report"
    - "User can one-click copy the visible report text to clipboard"
  artifacts:
    - path: "internal/analysis/report.go"
      provides: "ComputeReport function generating Markdown and plain text report strings"
      exports: ["ComputeReport"]
    - path: "internal/analysis/types.go"
      provides: "ReportData struct with Markdown and PlainText fields"
      contains: "ReportData"
    - path: "web/static/index.html"
      provides: "Report section with format toggle and copy button"
      contains: "report-section"
    - path: "web/static/js/dashboard.js"
      provides: "renderReport function with clipboard copy logic"
      contains: "renderReport"
  key_links:
    - from: "internal/analysis/analyze.go"
      to: "internal/analysis/report.go"
      via: "ComputeReport(result) call after all other computations"
      pattern: "ComputeReport"
    - from: "web/static/js/dashboard.js"
      to: "/api/analysis"
      via: "data.report in fetch response"
      pattern: "renderReport.*data\\.report"
    - from: "web/static/js/dashboard.js"
      to: "navigator.clipboard"
      via: "writeText() on copy button click"
      pattern: "navigator\\.clipboard\\.writeText"
---

<objective>
Implement daily quality report generation with Markdown/plain-text output and one-click clipboard copy.

Purpose: This is the capstone feature ‚Äî users import a CSV and immediately get a copy-paste-ready daily report for team communication, completing the full analysis workflow.
Output: `report.go` computation, `ReportData` type, report UI section with format toggle and copy button.
</objective>

<execution_context>
@C:/Users/zhang/.config/opencode/get-shit-done/workflows/execute-plan.md
@C:/Users/zhang/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@internal/analysis/types.go
@internal/analysis/analyze.go
@internal/analysis/kpi.go
@internal/analysis/age.go
@internal/analysis/workload.go
@internal/analysis/module.go
@internal/analysis/dateutil.go
@web/static/index.html
@web/static/js/dashboard.js
@web/static/css/style.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Go backend ‚Äî ReportData type + ComputeReport() generating Markdown and plain text</name>
  <files>internal/analysis/types.go, internal/analysis/report.go, internal/analysis/analyze.go</files>
  <action>
**types.go** ‚Äî Add `ReportData` struct to `AnalysisResult`:

```go
// In AnalysisResult, add:
Report *ReportData `json:"report,omitempty"`

// New type:
type ReportData struct {
    Markdown  string `json:"markdown"`
    PlainText string `json:"plainText"`
    Date      string `json:"date"` // "2026-02-11" format
}
```

**report.go** ‚Äî Create `ComputeReport(result *AnalysisResult) *ReportData`:

This function reads from the already-computed fields in `AnalysisResult` (KPI, Age, Workload, Module) and generates two report strings. Uses `fmt.Sprintf` and `strings.Builder` ‚Äî no templates library needed.

**Markdown format** (for tools like Feishu/DingTalk that render MD):
```
# Bug Ë¥®ÈáèÊó•Êä• ‚Äî {date}

## üìä ‰ªäÊó•Ê¶ÇËßà

| ÊåáÊ†á | Êï∞ÂÄº |
|------|------|
| ‰ªäÊó•Êñ∞Â¢û | {todayNew} |
| ‰ªäÊó•‰øÆÂ§ç | {todayFixed} |
| ÂáÄÂ¢ûÈïø | {+/-netChange} |
| ÊøÄÊ¥ªÊÄªÊï∞ | {active} |
| ÂæÖÈ™åËØÅ | {pendingVerify} |

## ‚ö†Ô∏è È´òÈ£éÈô© Bug È¢ÑË≠¶

> ‰∏•ÈáçÁ®ãÂ∫¶ 1-2 Á∫ß‰∏îÁßØÂéãË∂ÖËøá 7 Â§©

| BugÁºñÂè∑ | Ê†áÈ¢ò | ‰∏•ÈáçÁ®ãÂ∫¶ | ÊåáÊ¥æÁªô | ÁßØÂéãÂ§©Êï∞ |
|---------|------|---------|-------|---------|
| {id} | {title truncated to 30 chars} | {sevLabel} | {assignee} | {ageDays}Â§© |
(max 10 rows, show "...ÂèäÂÖ∂‰ªñ N Êù°" if more)

## üî• Áì∂È¢àÊ®°Âùó Top 5

| Ê®°Âùó | ÊøÄÊ¥ª Bug | ÊøÄÊ¥ªÁéá |
|------|---------|-------|
| {name} | {active} | {activeRate}% |

## üë• ‰∫∫ÂëòË¥üËΩΩ Top 5

| ‰∫∫Âëò | ÊøÄÊ¥ª Bug Êï∞ |
|------|-----------|
| {name} | {count} |
```

**Plain text format** (for IM paste):
```
„ÄêBug Ë¥®ÈáèÊó•Êä•„Äë{date}

‚ñé‰ªäÊó•Ê¶ÇËßà
  ‰ªäÊó•Êñ∞Â¢û: {todayNew} | ‰ªäÊó•‰øÆÂ§ç: {todayFixed} | ÂáÄÂ¢ûÈïø: {+/-netChange}
  ÊøÄÊ¥ªÊÄªÊï∞: {active} | ÂæÖÈ™åËØÅ: {pendingVerify}

‚ñéÈ´òÈ£éÈô© Bug È¢ÑË≠¶ (‰∏•ÈáçÁ®ãÂ∫¶1-2Á∫ß, ÁßØÂéã>7Â§©)
  #{id} {title30}  {sevLabel} | {assignee} | {ageDays}Â§©
  (max 10, then "...ÂèäÂÖ∂‰ªñ N Êù°")

‚ñéÁì∂È¢àÊ®°Âùó Top 5
  {name}: ÊøÄÊ¥ª {active} ‰∏™ ({activeRate}%)

‚ñé‰∫∫ÂëòË¥üËΩΩ Top 5
  {name}: ÊøÄÊ¥ª {count} ‰∏™
```

**Key logic:**
- `netChange = kpi.TodayNew - kpi.TodayFixed` ‚Äî prefix with "+" if positive, show as-is if negative
- Risk bugs: filter `Age.Backlog` where `Severity == "1" || Severity == "2"` AND `AgeDays > 7` ‚Äî cap display at 10
- Severity label map: "1"‚Üí"Ëá¥ÂëΩ", "2"‚Üí"‰∏•Èáç" (same as existing `severityLabels` in module.go)
- Bottleneck modules: take first 5 from `Module.Stats` where `Active > 0`
- Personnel load: take first 5 from `Workload.ByActive`
- If any section has no data, include a "ÊöÇÊó†Êï∞ÊçÆ" line
- Title truncation: if len([]rune(title)) > 30, truncate and append "‚Ä¶"
- Date from `Today().Format("2006-01-02")`

**analyze.go** ‚Äî Update `Analyze()` to call `ComputeReport` after building other fields:

```go
func Analyze(bugs []csvparse.Bug) *AnalysisResult {
    result := &AnalysisResult{
        KPI:      ComputeKPI(bugs),
        Severity: ComputeSeverity(bugs),
        Age:      ComputeAge(bugs),
        Workload: ComputeWorkload(bugs),
        Module:   ComputeModule(bugs),
    }
    result.Report = ComputeReport(result)
    return result
}
```
  </action>
  <verify>`go build ./...` compiles without errors. Manually inspect that `ComputeReport` handles nil sub-results gracefully (e.g., if Age is nil, skip risk section).</verify>
  <done>ReportData with Markdown and PlainText strings is included in the /api/analysis JSON response. Both formats contain KPI summary, risk bugs, bottleneck modules, and personnel load.</done>
</task>

<task type="auto">
  <name>Task 2: Frontend ‚Äî Report section UI with format toggle, copy button, and clipboard integration</name>
  <files>web/static/index.html, web/static/js/dashboard.js, web/static/css/style.css</files>
  <action>
**index.html** ‚Äî Add report section at the BOTTOM of the dashboard `<main>`, after the module trend chart row, before `</main>`:

```html
<!-- Êó•Êä•ÁîüÊàê -->
<div class="section-divider">
    <h2 class="section-title">Ë¥®ÈáèÊó•Êä•</h2>
</div>

<div class="report-card" id="report-section">
    <div class="chart-header">
        <h3 class="chart-title">Êó•Êä•ÂÜÖÂÆπ</h3>
        <div class="chart-controls">
            <div class="toggle-group" id="report-format-toggle">
                <button class="toggle-btn active" data-value="plain">Á∫ØÊñáÊú¨</button>
                <button class="toggle-btn" data-value="markdown">Markdown</button>
            </div>
            <button class="copy-btn" id="btn-copy-report">
                <svg viewBox="0 0 20 20" width="14" height="14" fill="currentColor">
                    <path d="M8 2a2 2 0 00-2 2v1H5a2 2 0 00-2 2v9a2 2 0 002 2h7a2 2 0 002-2v-1h1a2 2 0 002-2V6.414A2 2 0 0016.414 5L14 2.586A2 2 0 0012.586 2H8zm4 11H5V7h3v2a1 1 0 001 1h3v3zm0-5H9V5.5L12.5 8H12z"/>
                </svg>
                Â§çÂà∂Êó•Êä•
            </button>
        </div>
    </div>
    <pre class="report-content" id="report-content">Êï∞ÊçÆÂä†ËΩΩÂêéÊòæÁ§∫</pre>
    <div class="copy-toast" id="copy-toast">Â∑≤Â§çÂà∂Âà∞Ââ™Ë¥¥Êùø</div>
</div>
```

Default to "Á∫ØÊñáÊú¨" (plain text) since IM paste is the most common use case.

**dashboard.js** ‚Äî Add `renderReport(report)` function and wire it up:

1. Add module state vars: `var reportData = null; var currentReportFormat = 'plain';`

2. In `renderDashboard()` fetch callback, after `renderModule(data.module)`, add: `reportData = data.report; renderReport(data.report);`

3. `renderReport(report)`:
   - Get `#report-content` element
   - If `!report`, show "ÊöÇÊó†Êó•Êä•Êï∞ÊçÆ"
   - Set `textContent` based on `currentReportFormat`: 'plain' ‚Üí `report.plainText`, 'markdown' ‚Üí `report.markdown`

4. Report format toggle (follow existing toggle pattern):
   - Get `#report-format-toggle`, add click handler via event delegation
   - On toggle: update `currentReportFormat`, re-render with `renderReport(reportData)`

5. Copy button handler on `#btn-copy-report`:
   ```js
   var copyBtn = document.getElementById('btn-copy-report');
   if (copyBtn) {
       copyBtn.addEventListener('click', function () {
           if (!reportData) return;
           var text = currentReportFormat === 'plain' ? reportData.plainText : reportData.markdown;
           navigator.clipboard.writeText(text).then(function () {
               // Show toast
               var toast = document.getElementById('copy-toast');
               if (toast) {
                   toast.classList.add('show');
                   setTimeout(function () { toast.classList.remove('show'); }, 2000);
               }
           }).catch(function (err) {
               console.error('Â§çÂà∂Â§±Ë¥•:', err);
           });
       });
   }
   ```
   Initialize toggle and copy listeners inside `renderReport` (guard against double-init with a flag) or use a separate `initReportControls()` called once from `renderDashboard`.

**style.css** ‚Äî Add styles for report section:

```css
/* Report Card */
.report-card {
    background: var(--card-bg);
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    padding: 20px 24px;
    margin-bottom: 20px;
    position: relative;
}

.report-content {
    background: #f8f9fa;
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    padding: 16px 20px;
    font-family: "JetBrains Mono", "Fira Code", "Source Code Pro", Consolas, monospace;
    font-size: 13px;
    line-height: 1.7;
    white-space: pre-wrap;
    word-break: break-word;
    max-height: 600px;
    overflow-y: auto;
    color: var(--text);
}

/* Copy Button */
.copy-btn {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 6px 14px;
    border: 1px solid var(--primary);
    border-radius: var(--radius-sm);
    background: var(--primary-light);
    color: var(--primary);
    font-size: 13px;
    cursor: pointer;
    transition: all 0.2s;
}

.copy-btn:hover {
    background: var(--primary);
    color: #fff;
}

/* Copy Toast */
.copy-toast {
    position: absolute;
    top: 20px;
    right: 24px;
    background: var(--success);
    color: #fff;
    padding: 8px 16px;
    border-radius: var(--radius-sm);
    font-size: 13px;
    opacity: 0;
    transform: translateY(-8px);
    transition: all 0.3s;
    pointer-events: none;
}

.copy-toast.show {
    opacity: 1;
    transform: translateY(0);
}
```
  </action>
  <verify>`go build ./...` compiles. Open browser ‚Üí import CSV ‚Üí scroll to bottom ‚Üí "Ë¥®ÈáèÊó•Êä•" section visible. Toggle between Á∫ØÊñáÊú¨/Markdown ‚Üí content changes. Click "Â§çÂà∂Êó•Êä•" ‚Üí paste elsewhere ‚Üí content matches. Check the report includes KPI numbers, risk bugs, modules, and personnel.</verify>
  <done>Report section renders below the dashboard with format toggle and working clipboard copy. Plain text is default. Both formats contain matching data. Copy shows success toast and clipboard content pastes correctly.</done>
</task>

</tasks>

<verification>
1. `go build ./...` ‚Äî no compilation errors
2. Import CSV ‚Üí all existing dashboard sections render correctly (no regression)
3. Scroll to "Ë¥®ÈáèÊó•Êä•" section ‚Üí report content is populated
4. Toggle "Á∫ØÊñáÊú¨" ‚Üî "Markdown" ‚Üí report text changes format
5. Click "Â§çÂà∂Êó•Êä•" ‚Üí green toast appears ‚Üí paste into text editor ‚Üí content matches visible report
6. Report contains: date, today new/fixed/net change, risk bugs (severity 1-2, age >7d), top modules, top personnel
7. If no bugs match risk criteria, that section shows "ÊöÇÊó†È´òÈ£éÈô© Bug"
</verification>

<success_criteria>
- RPT-01: System auto-generates daily report in both Markdown and plain text after CSV import
- RPT-02: Report includes today's new/fixed/net-change counts
- RPT-03: Report highlights severity 1-2 bugs with long backlog (>7 days)
- RPT-04: Report includes bottleneck module and personnel overview
- RPT-05: User can one-click copy the generated report to clipboard
</success_criteria>

<output>
After completion, create `.planning/phases/04-daily-report-generation/04-01-SUMMARY.md`
</output>
