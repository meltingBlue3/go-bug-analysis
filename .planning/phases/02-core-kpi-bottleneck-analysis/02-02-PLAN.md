---
phase: 02-core-kpi-bottleneck-analysis
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - internal/analysis/age.go
  - internal/analysis/types.go
  - internal/analysis/analyze.go
  - internal/server/server.go
  - web/static/js/dashboard.js
  - web/static/index.html
  - web/static/css/style.css
autonomous: true

must_haves:
  truths:
    - "User sees average fix time for resolved bugs"
    - "User sees P50 (median) fix time for resolved bugs"
    - "User sees fix time distribution in 4 buckets: 0-1d, 2-3d, 4-7d, 7+d"
    - "User sees unresolved bugs listed in descending order by backlog age in days"
  artifacts:
    - path: "internal/analysis/age.go"
      provides: "ComputeAge function: fix time stats + backlog ranking"
      exports: ["ComputeAge"]
    - path: "internal/analysis/types.go"
      provides: "AgeData, FixTimeStats, BacklogItem structs"
      contains: "AgeData"
  key_links:
    - from: "internal/analysis/age.go"
      to: "internal/analysis/dateutil.go"
      via: "Uses ParseDate to compute durations"
      pattern: "ParseDate"
    - from: "internal/analysis/analyze.go"
      to: "internal/analysis/age.go"
      via: "Analyze() calls ComputeAge()"
      pattern: "ComputeAge"
    - from: "web/static/js/dashboard.js"
      to: "response.age"
      via: "renderAge() reads age data from API response"
      pattern: "renderAge"
---

<objective>
Fix time statistics, age distribution chart, and backlog age ranking table

Purpose: Surface fix time bottlenecks and long-standing unresolved bugs so users can identify where bugs are stuck and prioritize resolution. This is the core bottleneck analysis feature.

Output: Fix time summary cards (average + P50), fix time distribution ECharts bar chart with 4 time buckets, scrollable backlog ranking table showing unresolved bugs sorted by age in descending order.
</objective>

<execution_context>
@C:/Users/zhang/.config/opencode/get-shit-done/workflows/execute-plan.md
@C:/Users/zhang/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-core-kpi-bottleneck-analysis/02-01-SUMMARY.md
@internal/analysis/types.go
@internal/analysis/dateutil.go
@internal/analysis/analyze.go
@internal/server/server.go
@web/static/js/dashboard.js
@web/static/index.html
</context>

<tasks>

<task type="auto">
  <name>Task 1: Backend — Fix time computation and backlog age ranking</name>
  <files>
    internal/analysis/age.go
    internal/analysis/types.go
    internal/analysis/analyze.go
  </files>
  <action>
**Add types to `internal/analysis/types.go`:**
```go
type AgeData struct {
    FixTime  *FixTimeStats  `json:"fixTime"`
    Backlog  []BacklogItem  `json:"backlog"`  // sorted descending by AgeDays
}

type FixTimeStats struct {
    AvgHours     float64           `json:"avgHours"`     // average fix time in hours
    AvgDays      float64           `json:"avgDays"`      // average fix time in days (avgHours/24)
    P50Hours     float64           `json:"p50Hours"`     // median fix time in hours
    P50Days      float64           `json:"p50Days"`      // median fix time in days
    Distribution []DistBucket      `json:"distribution"` // 4 buckets
    TotalResolved int              `json:"totalResolved"` // how many bugs had valid fix times
}

type DistBucket struct {
    Label string `json:"label"` // "0-1天", "2-3天", "4-7天", "7天以上"
    Count int    `json:"count"`
}

type BacklogItem struct {
    ID        string `json:"id"`
    Title     string `json:"title"`
    Severity  string `json:"severity"`
    Assignee  string `json:"assignee"`
    CreatedDate string `json:"createdDate"`
    AgeDays   int    `json:"ageDays"` // days since creation
}
```

Add `Age *AgeData` field to `AnalysisResult` struct with json tag `"age,omitempty"`.

**Create `internal/analysis/age.go`:**
- `ComputeAge(bugs []csvparse.Bug) *AgeData` — main function, calls computeFixTime and computeBacklog.

- `computeFixTime(bugs []csvparse.Bug) *FixTimeStats`:
  - For each bug with non-empty ResolvedDate AND CreatedDate:
    - Parse both with `ParseDate()`. If either fails, skip.
    - Calculate duration = resolvedTime.Sub(createdTime).
    - Only include positive durations (resolved after creation).
    - Collect all durations in a slice.
  - If no valid durations, return nil (no data).
  - Calculate average: sum(durations) / len(durations).
  - Calculate P50 (median): sort durations, take middle element (or average of two middle for even count). Use `sort.Slice`.
  - Distribution buckets — classify each duration:
    - 0-1天: duration <= 24h
    - 2-3天: 24h < duration <= 72h
    - 4-7天: 72h < duration <= 168h
    - 7天以上: duration > 168h
  - Return FixTimeStats with all fields.

- `computeBacklog(bugs []csvparse.Bug) []BacklogItem`:
  - Filter: bugs where Status == "激活" (active/unresolved).
  - For each active bug, parse CreatedDate to compute ageDays = daysBetween(createdDate, today).
  - Use `int(time.Since(createdTime).Hours() / 24)` for age in days.
  - If CreatedDate unparseable, set ageDays = 0 and still include.
  - Build BacklogItem with id, title, severity, assignee, createdDate, ageDays.
  - Sort descending by ageDays. Use `sort.Slice`.
  - Return full list (frontend will handle pagination/scrolling).

**Update `internal/analysis/analyze.go`:**
- Add `result.Age = ComputeAge(bugs)` call in the Analyze function.
  </action>
  <verify>
Run `go build ./...` — must compile.
Run `go vet ./...` — no warnings.
Start server, upload CSV, curl `/api/analysis` — response now includes `age` field with `fixTime` (avgHours, p50Hours, distribution with 4 buckets) and `backlog` array sorted by ageDays descending.
  </verify>
  <done>
API returns age analysis: fix time average/P50 in hours and days, distribution across 4 time buckets, and backlog items sorted descending by age. All active bugs appear in backlog list with computed ageDays.
  </done>
</task>

<task type="auto">
  <name>Task 2: Frontend — Fix time stats display, distribution chart, and backlog age table</name>
  <files>
    web/static/js/dashboard.js
    web/static/index.html
    web/static/css/style.css
  </files>
  <action>
**Update `web/static/index.html`:**
Add two new sections AFTER the severity chart row in the dashboard:

1. **Fix time section** — a chart row with two cards:
   ```html
   <div class="chart-row">
       <div class="chart-card" id="fix-time-stats-card">
           <h3 class="chart-title">修复时效统计</h3>
           <div class="fix-time-summary" id="fix-time-summary">
               <!-- Filled by JS: avg, P50 stat boxes -->
           </div>
       </div>
       <div class="chart-card">
           <h3 class="chart-title">修复时长分布</h3>
           <div class="chart-container" id="chart-fix-time-dist"></div>
       </div>
   </div>
   ```

2. **Backlog table section** — full-width card:
   ```html
   <div class="data-table-card" id="backlog-card">
       <div class="chart-header">
           <h3 class="chart-title">未解决 Bug 积压排名</h3>
           <span class="backlog-count" id="backlog-count"></span>
       </div>
       <div class="table-scroll">
           <table class="data-table" id="backlog-table">
               <thead>
                   <tr>
                       <th>Bug编号</th>
                       <th>标题</th>
                       <th>严重程度</th>
                       <th>指派给</th>
                       <th>创建日期</th>
                       <th>积压天数</th>
                   </tr>
               </thead>
               <tbody id="backlog-tbody"></tbody>
           </table>
       </div>
   </div>
   ```

**Update `web/static/js/dashboard.js`:**
Extend `renderDashboard()` to also call `renderAge(data.age)` after existing renders.

- `renderFixTimeStats(fixTime)`:
  - If fixTime is null/undefined, show "暂无已解决 Bug 数据" message.
  - Render two big stat boxes inside `#fix-time-summary`:
    - Box 1: "平均修复时长" with value formatted as: if < 24h show "X.X 小时", else "X.X 天".
    - Box 2: "P50 修复时长" with same formatting.
    - Below: "共 N 条已解决记录" subtitle.
  - Render horizontal bar chart in `#chart-fix-time-dist` using ECharts:
    - Y-axis: bucket labels (0-1天, 2-3天, 4-7天, 7天以上) in reverse order (top = smallest).
    - X-axis: count.
    - Bars with gradient colors: green for fast → red for slow.
    - Show value labels on bars.
    - Chart height: 240px (set chart-container min-height for this specific container).

- `renderBacklogTable(backlog)`:
  - Update `#backlog-count` with "共 N 条".
  - If empty, show "暂无未解决 Bug" in tbody.
  - For each BacklogItem, create a table row:
    - Bug编号: plain text
    - 标题: truncate to 40 chars with ellipsis if longer
    - 严重程度: show as colored badge (1=red, 2=orange, 3=blue, 4=green)
    - 指派给: plain text
    - 创建日期: show date portion only (first 10 chars)
    - 积压天数: show number with color coding (>30 days = red, >14 days = orange, else normal)
  - Table should be scrollable if too many rows (max-height with overflow-y scroll on `.table-scroll`).
  - Show all rows (no pagination needed — typically <500 active bugs).

- `renderAge(ageData)` — orchestrator that calls renderFixTimeStats and renderBacklogTable.

**Update `web/static/css/style.css`:**
- `.fix-time-summary`: display grid, grid-template-columns repeat(2, 1fr), gap 16px.
- `.stat-box`: background var(--bg), border-radius var(--radius-sm), padding 20px, text-align center.
- `.stat-box .stat-value`: font-size 32px, font-weight 700, color var(--primary).
- `.stat-box .stat-label`: font-size 13px, color var(--text-secondary), margin-bottom 8px.
- `.stat-box .stat-unit`: font-size 14px, color var(--text-secondary), margin-left 4px.
- `.table-scroll`: max-height 480px, overflow-y auto.
- `.data-table`: width 100%, border-collapse collapse, font-size 13px.
- `.data-table th`: background var(--bg), padding 10px 12px, text-align left, font-weight 600, position sticky, top 0, z-index 1.
- `.data-table td`: padding 8px 12px, border-bottom 1px solid var(--border).
- `.data-table tr:hover`: background var(--primary-light).
- `.severity-badge`: display inline-block, padding 2px 8px, border-radius 10px, font-size 12px, font-weight 500.
- `.severity-badge.s1`: background #fff2f0, color #ff4d4f.
- `.severity-badge.s2`: background #fffbe6, color #faad14.
- `.severity-badge.s3`: background #e6f7ff, color #1890ff.
- `.severity-badge.s4`: background #f6ffed, color #52c41a.
- `.age-danger`: color var(--error), font-weight 600.
- `.age-warning`: color var(--warning), font-weight 600.
- `.backlog-count`: font-size 13px, color var(--text-muted), font-weight normal.
  </action>
  <verify>
Start server, upload CSV. Verify:
1. Fix time stats section shows average and P50 with proper formatting.
2. Distribution chart shows 4 buckets with correct counts.
3. Backlog table lists active bugs sorted by age descending.
4. Severity badges have correct colors.
5. Age column shows red for 30+ days, orange for 14+ days.
6. Table scrolls when content exceeds max-height.
7. All charts resize properly.
  </verify>
  <done>
Fix time section displays average/P50 stats and distribution bar chart. Backlog table shows all unresolved bugs ranked by age with severity badges and age color coding. Requirements AGE-01 through AGE-05 satisfied.
  </done>
</task>

</tasks>

<verification>
1. `go build ./...` and `go vet ./...` pass
2. Upload CSV → fix time stats appear with avg and P50 values
3. Distribution chart shows 4 time buckets with counts
4. Backlog table shows active bugs sorted by ageDays descending
5. Table severity badges and age color coding are correct
6. Scrollable table works for many rows
</verification>

<success_criteria>
- Average and P50 fix times display for resolved bugs
- Fix time distribution chart shows 4 buckets (0-1d, 2-3d, 4-7d, 7+d)
- Backlog table shows all unresolved bugs sorted by age descending
- Age values are correctly calculated from creation date to today
</success_criteria>

<output>
After completion, create `.planning/phases/02-core-kpi-bottleneck-analysis/02-02-SUMMARY.md`
</output>
