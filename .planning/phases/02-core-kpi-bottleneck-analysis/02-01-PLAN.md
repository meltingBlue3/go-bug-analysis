---
phase: 02-core-kpi-bottleneck-analysis
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - internal/analysis/types.go
  - internal/analysis/dateutil.go
  - internal/analysis/kpi.go
  - internal/analysis/severity.go
  - internal/analysis/analyze.go
  - internal/server/server.go
  - web/static/index.html
  - web/static/css/style.css
  - web/static/js/app.js
  - web/static/js/dashboard.js
autonomous: true

must_haves:
  truths:
    - "User sees today's and yesterday's new bug counts as KPI cards after CSV import"
    - "User sees today's and yesterday's fixed bug counts as KPI cards after CSV import"
    - "User sees bug inventory counts: total, active, pending-verification"
    - "User sees severity distribution chart toggleable between pie and bar chart"
    - "User can filter severity chart between 'new bugs only' and 'all bugs'"
  artifacts:
    - path: "internal/analysis/types.go"
      provides: "AnalysisResult, KPIData, SeverityData structs"
    - path: "internal/analysis/dateutil.go"
      provides: "ParseDate, SameDay date utilities for Zentao date strings"
    - path: "internal/analysis/kpi.go"
      provides: "ComputeKPI function returning today/yesterday/inventory counts"
    - path: "internal/analysis/severity.go"
      provides: "ComputeSeverity function returning distribution for all/new-only"
    - path: "web/static/js/dashboard.js"
      provides: "Dashboard rendering module with KPI cards and severity ECharts"
  key_links:
    - from: "internal/server/server.go"
      to: "internal/analysis/"
      via: "GET /api/analysis imports and calls Analyze()"
      pattern: "analysis\\.Analyze"
    - from: "web/static/js/dashboard.js"
      to: "/api/analysis"
      via: "fetch('/api/analysis') on dashboard show"
      pattern: "fetch.*api/analysis"
    - from: "web/static/js/app.js"
      to: "web/static/js/dashboard.js"
      via: "BugAnalysis.renderDashboard() called after upload success"
      pattern: "renderDashboard"
---

<objective>
KPI cards and severity distribution charts with toggle controls

Purpose: Give users immediate visibility into bug inventory status and severity breakdown after CSV import. This is the first analysis feature — establishes the analysis package pattern, API endpoint, and dashboard rendering module that 02-02 and 02-03 will extend.

Output: 5 KPI cards (today/yesterday new, today/yesterday fixed, total, active, pending-verification), severity distribution ECharts chart with pie/bar toggle and new-only/all-bugs filter.
</objective>

<execution_context>
@C:/Users/zhang/.config/opencode/get-shit-done/workflows/execute-plan.md
@C:/Users/zhang/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-csv-pipeline/01-02-SUMMARY.md
@internal/csvparse/types.go
@internal/server/server.go
@web/static/index.html
@web/static/js/app.js
@web/static/css/style.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Analysis package — date utils, KPI computation, severity distribution, and API endpoint</name>
  <files>
    internal/analysis/types.go
    internal/analysis/dateutil.go
    internal/analysis/kpi.go
    internal/analysis/severity.go
    internal/server/server.go
  </files>
  <action>
Create `internal/analysis/` package with four files:

**types.go** — Define the analysis result types:
```go
package analysis

type AnalysisResult struct {
    KPI      *KPIData      `json:"kpi"`
    Severity *SeverityData `json:"severity"`
}

type KPIData struct {
    TodayNew        int `json:"todayNew"`
    YesterdayNew    int `json:"yesterdayNew"`
    TodayFixed      int `json:"todayFixed"`
    YesterdayFixed  int `json:"yesterdayFixed"`
    Total           int `json:"total"`
    Active          int `json:"active"`
    PendingVerify   int `json:"pendingVerify"`
}

type SeverityItem struct {
    Level string `json:"level"` // "1","2","3","4"
    Label string `json:"label"` // "致命","严重","一般","轻微"
    Count int    `json:"count"`
}

type SeverityData struct {
    All     []SeverityItem `json:"all"`
    NewOnly []SeverityItem `json:"newOnly"` // today's new bugs only
}
```

**dateutil.go** — Date parsing utilities for Zentao date strings:
- `ParseDate(s string) (time.Time, bool)` — tries format `"2006-01-02 15:04:05"` first, then `"2006-01-02"`. Returns zero+false for empty strings, `"0000-00-00"` prefix, or unparseable values.
- `DateOnly(t time.Time) time.Time` — truncates to midnight (year, month, day).
- `Today()` and `Yesterday()` — return today/yesterday at midnight using `time.Now()`.

**kpi.go** — KPI computation:
- `ComputeKPI(bugs []csvparse.Bug) *KPIData` — iterates bugs once:
  - Parse `CreatedDate` to check if same day as Today/Yesterday → increment todayNew/yesterdayNew
  - Parse `ResolvedDate` to check if same day as Today/Yesterday → increment todayFixed/yesterdayFixed
  - Count total: `len(bugs)`
  - Count active: `Status == "激活"`
  - Count pending verification: `Status == "已解决"` (resolved but not closed = awaiting QA)
- Use `DateOnly()` comparison for day matching to avoid time-of-day issues.

**severity.go** — Severity distribution:
- `ComputeSeverity(bugs []csvparse.Bug, todayNewBugs []csvparse.Bug) *SeverityData`
- Severity label mapping: "1"→"致命", "2"→"严重", "3"→"一般", "4"→"轻微". Unknown values → "未设置".
- Count bugs per severity level for all bugs and for todayNewBugs.
- Always return all 4 levels (even if count is 0) so charts render consistently.
- Helper: `filterTodayNew(bugs []csvparse.Bug) []csvparse.Bug` — returns bugs where CreatedDate matches today.

**Top-level Analyze function** in a new file `internal/analysis/analyze.go`:
- `Analyze(bugs []csvparse.Bug) *AnalysisResult` — calls ComputeKPI and ComputeSeverity, assembles result.

**Modify `internal/server/server.go`:**
- Import `go-bug-analysis/internal/analysis`
- Add route in `New()`: `mux.HandleFunc("GET /api/analysis", handleAnalysis(state))`
- Add `handleAnalysis` handler: reads `state.GetResult()`, returns 400 if nil ("请先上传 CSV 文件"), otherwise calls `analysis.Analyze(result.Bugs)` and returns JSON.
  </action>
  <verify>
Run `go build ./...` — must compile without errors.
Run `go vet ./...` — no warnings.
Start server, upload 2225.csv, then `curl http://localhost:18088/api/analysis` returns JSON with `kpi` and `severity` fields populated.
  </verify>
  <done>
GET /api/analysis returns correct KPI counts (todayNew, yesterdayNew, todayFixed, yesterdayFixed based on current date; total=2225, active/pendingVerify counted by status) and severity distribution with all 4 levels for both "all" and "newOnly" arrays.
  </done>
</task>

<task type="auto">
  <name>Task 2: Frontend — KPI card rendering and severity chart with toggle controls</name>
  <files>
    web/static/js/dashboard.js
    web/static/index.html
    web/static/js/app.js
    web/static/css/style.css
  </files>
  <action>
**Create `web/static/js/dashboard.js`** — new IIFE module following established pattern:

```js
(function () {
    'use strict';
    // ... module code ...
    // Extend BugAnalysis public API
    window.BugAnalysis.renderDashboard = renderDashboard;
})();
```

Module responsibilities:
1. `renderDashboard()` — fetches `GET /api/analysis`, calls renderKPI() and renderSeverityChart().
2. `renderKPI(kpi)` — populates the 5 KPI cards in `#kpi-cards`:
   - Card layout: 今日新增 (with "昨日: N" subtitle), 今日修复 (with "昨日: N" subtitle), Bug 总数, 激活 Bug, 待验证
   - Remove placeholder-card class, set real values.
   - Use color coding: active bugs in red/orange if > 0, pending-verify in warning color.
   - Each card shows the number prominently and a secondary line for context (e.g., "昨日: 5" under today's new count).
3. `renderSeverityChart(severity)` — renders ECharts chart in `#chart-severity`:
   - Initialize ECharts instance: `echarts.init(document.getElementById('chart-severity'))`
   - Default view: pie chart showing "all bugs" severity distribution.
   - Toggle bar in chart card header with two control groups:
     - Chart type: 饼图 / 柱状图 (pie/bar) toggle buttons
     - Data scope: 全部 / 仅新增 (all/new-only) toggle buttons
   - On toggle click: update chart with `chart.setOption(newOption, true)`.
   - Pie chart options: radius '55%', label with `{b}: {c} ({d}%)`, rose type for visual impact.
   - Bar chart options: x-axis = severity labels, y-axis = count, bars with rounded corners.
   - Color scheme: severity 1 (致命) = #ff4d4f (red), 2 (严重) = #faad14 (orange), 3 (一般) = #1890ff (blue), 4 (轻微) = #52c41a (green).
   - Handle window resize: `window.addEventListener('resize', function() { chart.resize(); })`.
4. Store chart instance in module scope for resize handling and option updates.

**Modify `web/static/index.html`:**
- Update `#kpi-cards` section: change to 5 KPI cards with proper structure:
  ```html
  <div class="kpi-card" id="kpi-today-new">
      <div class="kpi-label">今日新增</div>
      <div class="kpi-value">—</div>
      <div class="kpi-sub">昨日: —</div>
  </div>
  ```
  Cards: kpi-today-new, kpi-today-fixed, kpi-total, kpi-active, kpi-pending
- Update severity chart card: add toggle button group in header area:
  ```html
  <div class="chart-card">
      <div class="chart-header">
          <h3 class="chart-title">严重程度分布</h3>
          <div class="chart-controls">
              <div class="toggle-group" id="severity-type-toggle">
                  <button class="toggle-btn active" data-value="pie">饼图</button>
                  <button class="toggle-btn" data-value="bar">柱状图</button>
              </div>
              <div class="toggle-group" id="severity-scope-toggle">
                  <button class="toggle-btn active" data-value="all">全部</button>
                  <button class="toggle-btn" data-value="new">仅新增</button>
              </div>
          </div>
      </div>
      <div class="chart-container" id="chart-severity"></div>
  </div>
  ```
- Remove the module chart placeholder card (will be added in Phase 3).
- Remove the data table placeholder card (will be replaced by backlog table in 02-02).
- Add `<script src="js/dashboard.js" defer></script>` AFTER app.js in the script loading order.
- Add a "重新导入" link/button in the dashboard header area so users can go back to upload view.

**Modify `web/static/js/app.js`:**
- In the upload success handler, after `showDashboard()`, call `window.BugAnalysis.renderDashboard()`:
  ```js
  setTimeout(function () {
      showDashboard();
      if (window.BugAnalysis.renderDashboard) {
          window.BugAnalysis.renderDashboard();
      }
  }, 1500);
  ```

**Modify `web/static/css/style.css`:**
- Add `.kpi-sub` style: font-size 12px, color var(--text-muted), margin-top 4px.
- Add `.kpi-card.kpi-warning .kpi-value` style: color var(--warning).
- Add `.kpi-card.kpi-danger .kpi-value` style: color var(--error).
- Add `.chart-header` style: display flex, justify-content space-between, align-items center, wrapping on small screens.
- Add `.chart-controls` style: display flex, gap 8px, flex-wrap wrap.
- Add `.toggle-group` style: display inline-flex, border 1px solid var(--border), border-radius var(--radius-sm), overflow hidden.
- Add `.toggle-btn` style: padding 4px 12px, font-size 12px, border none, background transparent, cursor pointer, transition background 0.2s.
- Add `.toggle-btn.active` style: background var(--primary), color white.
- Add `.toggle-btn:hover:not(.active)` style: background var(--primary-light).
- Add `.reimport-btn` style for the "重新导入" button in dashboard: subtle link style, positioned in top area.
  </action>
  <verify>
Run `go build ./...` — must compile (embed.FS picks up new JS file).
Start server, upload CSV. Verify:
1. KPI cards show real numbers (not "—").
2. Severity chart renders as pie chart by default.
3. Clicking 柱状图 switches to bar chart; clicking 饼图 switches back.
4. Clicking 仅新增 shows only today's new bugs severity; clicking 全部 shows all.
5. "重新导入" button returns to upload view.
6. Chart resizes properly on window resize.
  </verify>
  <done>
5 KPI cards display real counts from analysis API. Severity chart renders with working pie/bar toggle and all/new-only data filter. Dashboard has re-import navigation. All matching requirements KPI-01 through KPI-05.
  </done>
</task>

</tasks>

<verification>
1. `go build ./...` and `go vet ./...` pass
2. Upload 2225.csv → KPI cards populate with correct numbers
3. Severity pie chart renders with 4 severity levels
4. Toggle between pie and bar chart works
5. Toggle between all bugs and new-only works
6. "重新导入" returns to upload view
7. Browser resize → chart resizes
</verification>

<success_criteria>
- KPI cards show today/yesterday new counts, today/yesterday fixed counts, total, active, and pending-verification
- Severity chart toggles between pie and bar
- Severity chart filters between all bugs and today's new bugs only
- Analysis API endpoint returns correct JSON data
</success_criteria>

<output>
After completion, create `.planning/phases/02-core-kpi-bottleneck-analysis/02-01-SUMMARY.md`
</output>
