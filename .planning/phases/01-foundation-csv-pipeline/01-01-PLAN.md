---
phase: 01-foundation-csv-pipeline
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - main.go
  - go.mod
  - internal/server/server.go
  - web/embed.go
  - web/static/index.html
  - web/static/css/style.css
  - web/static/js/app.js
  - web/static/js/lib/echarts.min.js
autonomous: true

must_haves:
  truths:
    - "运行可执行文件后，默认浏览器自动打开应用页面"
    - "应用在 2 秒内启动完成并可访问"
    - "页面显示中文界面，包含 CSV 文件上传区域"
    - "前端资源（HTML/CSS/JS/ECharts）全部内嵌在单个可执行文件中"
  artifacts:
    - path: "main.go"
      provides: "程序入口：启动 HTTP 服务、自动打开浏览器"
      contains: "openBrowser"
    - path: "go.mod"
      provides: "Go module 定义"
      contains: "module go-bug-analysis"
    - path: "internal/server/server.go"
      provides: "HTTP 服务器：路由注册、静态文件服务"
      exports: ["New"]
    - path: "web/embed.go"
      provides: "embed.FS 指令，嵌入 web/static 目录"
      contains: "go:embed"
    - path: "web/static/index.html"
      provides: "仪表盘页面外壳：标题栏、上传区域、仪表盘占位"
      min_lines: 50
    - path: "web/static/css/style.css"
      provides: "现代化中文友好的仪表盘样式"
      min_lines: 80
    - path: "web/static/js/app.js"
      provides: "前端逻辑：上传交互、状态显示、模块化结构"
      min_lines: 30
    - path: "web/static/js/lib/echarts.min.js"
      provides: "ECharts 图表库（离线内嵌）"
  key_links:
    - from: "web/embed.go"
      to: "web/static/"
      via: "//go:embed all:static"
      pattern: "go:embed"
    - from: "main.go"
      to: "web.StaticFiles"
      via: "import go-bug-analysis/web, fs.Sub 剥离 static 前缀"
      pattern: "fs\\.Sub.*static"
    - from: "main.go"
      to: "internal/server.New()"
      via: "传入 staticFS 创建 handler"
      pattern: "server\\.New"
    - from: "internal/server/server.go"
      to: "http.FileServer"
      via: "将 embed.FS 作为静态文件服务挂载到 /"
      pattern: "FileServer"
    - from: "main.go"
      to: "openBrowser()"
      via: "goroutine 延迟 300ms 后打开浏览器"
      pattern: "go func.*openBrowser"
---

<objective>
搭建 Go 项目脚手架：包括 Go module 初始化、HTTP 服务器、embed.FS 静态资源嵌入、自动打开浏览器，以及带上传区域的前端仪表盘外壳。

Purpose: 建立单文件可执行程序的基础架构，后续所有功能（CSV 解析、图表渲染、日报生成）都在此骨架上扩展。
Output: 可编译运行的单文件程序，启动后自动打开浏览器显示中文仪表盘页面。
</objective>

<execution_context>
@C:/Users/zhang/.config/opencode/get-shit-done/workflows/execute-plan.md
@C:/Users/zhang/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@需求与设计文档.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Go 项目脚手架 — module、HTTP 服务器、embed.FS、自动打开浏览器</name>
  <files>go.mod, main.go, internal/server/server.go, web/embed.go</files>
  <action>
1. 初始化 Go module：
   - `go mod init go-bug-analysis`
   - Go 版本 1.21 或以上（需要 net/http 的 method-based routing `mux.HandleFunc("POST /path", fn)`，Go 1.22+ 特性；如果用 1.21 则用传统 HandleFunc + 方法检查）
   - 建议使用 Go 1.22+，利用内置的 method-based routing

2. 创建 `web/embed.go`：
   ```go
   package web

   import "embed"

   //go:embed all:static
   var StaticFiles embed.FS
   ```

3. 创建 `internal/server/server.go`：
   - 导出 `New(staticFS fs.FS) http.Handler` 函数
   - 创建 `http.NewServeMux()`
   - 将 `staticFS` 挂载为 `http.FileServer(http.FS(staticFS))` 服务到 `"/"`
   - 预留 `/api/` 前缀路由区域（Plan 02 将添加 `/api/upload`）
   - 不使用第三方路由库，仅 `net/http` 标准库

4. 创建 `main.go`：
   - 解析命令行参数 `-port`（默认 18088）
   - 通过 `fs.Sub(web.StaticFiles, "static")` 剥离 `static/` 前缀
   - 调用 `server.New(staticFS)` 创建 handler
   - 创建 `http.Server{Addr: ":port", Handler: handler}`
   - 在 goroutine 中启动服务器监听
   - 在另一 goroutine 中延迟 300ms 后调用 `openBrowser("http://localhost:PORT")`
   - 监听 `os.Interrupt` 信号（`signal.Notify`），收到后调用 `srv.Shutdown(ctx)` 优雅退出
   - 日志输出中文启动信息：`"服务已启动: http://localhost:PORT"`

5. 实现 `openBrowser(url string)` 函数（在 main.go 中）：
   - 根据 `runtime.GOOS` 选择命令：
     - `"windows"`: `exec.Command("cmd", "/c", "start", url)`
     - `"darwin"`: `exec.Command("open", url)`
     - 默认: `exec.Command("xdg-open", url)`
   - 忽略错误（浏览器打不开不应阻止服务运行）

6. 运行 `go mod tidy` 确保依赖干净
  </action>
  <verify>
- `go build -o go-bug-analysis.exe .` 编译成功，生成单文件
- `go vet ./...` 无警告
- 运行可执行文件后终端显示启动日志，浏览器自动打开 http://localhost:18088
  </verify>
  <done>
Go 项目可编译为单文件可执行程序，运行后 HTTP 服务器在指定端口监听，浏览器自动打开应用首页，Ctrl+C 可优雅退出。
  </done>
</task>

<task type="auto">
  <name>Task 2: 前端仪表盘外壳 — HTML 页面、CSS 样式、ECharts 内嵌、上传区域 UI</name>
  <files>web/static/index.html, web/static/css/style.css, web/static/js/app.js, web/static/js/lib/echarts.min.js</files>
  <action>
1. 下载 ECharts 用于离线内嵌：
   - 使用 curl 或 PowerShell 下载 ECharts 5.x 压缩版：
     `curl -L -o web/static/js/lib/echarts.min.js "https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"`
   - 若 curl 不可用（Windows），使用 PowerShell：
     `Invoke-WebRequest -Uri "https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js" -OutFile "web/static/js/lib/echarts.min.js"`
   - 确认文件大小约 1MB（非空）

2. 创建 `web/static/index.html`：
   - `<!DOCTYPE html>` + `<html lang="zh-CN">`
   - `<meta charset="UTF-8">`，`<meta name="viewport" ...>` 响应式
   - `<title>禅道 Bug 分析工具</title>`
   - 引入 `css/style.css`、`js/lib/echarts.min.js`、`js/app.js`（app.js 用 defer）
   - 页面结构：
     a. **顶部导航栏** (`<header>`)：应用标题 "禅道 Bug 分析工具"，右侧显示版本号 "v1.0"
     b. **上传区域** (`<section id="upload-section">`)：居中显示，包含：
        - 大图标或 SVG（文件图标）
        - 文件选择按钮：`<input type="file" id="csv-file" accept=".csv">`，包裹在自定义样式按钮中
        - 说明文字："选择禅道导出的 CSV 文件"
        - 上传状态区 (`<div id="upload-status">`)：显示进度、成功、或错误信息
     c. **仪表盘区域** (`<main id="dashboard">`)：初始 `display: none`，上传成功后显示
        - KPI 卡片行容器 (`<div id="kpi-cards" class="card-row">`)：4 个空卡片占位
        - 图表行容器 (`<div id="charts-row" class="chart-row">`)：2 列布局占位
        - 数据表容器 (`<div id="data-table">`)：占位
        - 每个占位区域显示浅色背景 + "数据加载后显示" 提示文字

3. 创建 `web/static/css/style.css`：
   - **CSS 变量**（`:root`）：
     - `--primary`: #1890ff（蓝色主色调）
     - `--bg`: #f0f2f5（浅灰背景）
     - `--card-bg`: #ffffff
     - `--text`: #333333
     - `--text-secondary`: #666666
     - `--border`: #e8e8e8
     - `--success`: #52c41a
     - `--error`: #ff4d4f
     - `--warning`: #faad14
   - **字体栈**：`-apple-system, BlinkMacSystemFont, "PingFang SC", "Microsoft YaHei", "Segoe UI", sans-serif`
   - **全局重置**：box-sizing: border-box, margin/padding 0
   - **Header**：固定高度 56px，白色背景，底部阴影，flex 布局左右对齐
   - **上传区域**：居中容器（max-width 480px），白色圆角卡片，虚线边框，hover 变色
   - **上传按钮**：`--primary` 背景色，白色文字，圆角 6px，hover 加深，cursor pointer
   - **上传状态**：分三种状态样式（.status-info 蓝色、.status-success 绿色、.status-error 红色）
   - **仪表盘**：max-width 1200px 居中，padding 24px
   - **KPI 卡片行**：CSS Grid `grid-template-columns: repeat(auto-fit, minmax(220px, 1fr))`，gap 16px
   - **卡片**：白色背景，border-radius 8px，box-shadow 0 2px 8px rgba(0,0,0,0.06)，padding 20px
   - **图表行**：两列 Grid 布局，每列一个图表容器（min-height 360px）
   - **响应式**：@media (max-width: 768px) 单列堆叠

4. 创建 `web/static/js/app.js`：
   - 使用 IIFE 或 ES module 避免全局污染（IIFE 更安全因为不需要 module type）
   - **初始化**：DOMContentLoaded 事件绑定
   - **文件选择监听**：监听 `#csv-file` 的 `change` 事件
     - 获取选中文件，检查是否为 .csv 扩展名
     - 显示文件名和大小到状态区
     - 调用 `uploadCSV(file)` 函数（函数体目前仅显示 "文件已选择，上传功能将在下一步实现"）
   - **状态显示函数** `showStatus(message, type)`：
     - type 可选 'info' | 'success' | 'error'
     - 设置 `#upload-status` 的 innerHTML 和 class
   - **仪表盘显示函数** `showDashboard()`：
     - 隐藏上传区域，显示仪表盘区域
   - **预留接口**：
     - `window.BugAnalysis = { showStatus, showDashboard }` 暴露给后续模块使用

5. 重新编译验证：`go build -o go-bug-analysis.exe .` 确保嵌入的新文件编译成功
  </action>
  <verify>
- `go build -o go-bug-analysis.exe .` 编译成功
- 运行后浏览器打开看到：蓝色顶栏标题、居中上传区域、美观的中文界面
- 点击上传按钮可选择文件，选择后状态区显示文件名
- 编译产物为单个 exe 文件，包含所有前端资源（无需额外文件）
  </verify>
  <done>
前端仪表盘外壳完成：页面显示专业中文界面，包含文件上传区域和仪表盘占位布局。ECharts 已内嵌。编译为单文件 exe 后所有资源可正常加载。
  </done>
</task>

</tasks>

<verification>
1. `go build -o go-bug-analysis.exe .` — 编译为单文件，无错误
2. `go vet ./...` — 无警告
3. 运行 exe 后浏览器自动打开，页面在 2 秒内可见
4. 页面显示中文标题、上传区域、样式正确
5. 选择 CSV 文件后状态区有响应
6. Ctrl+C 可优雅退出
</verification>

<success_criteria>
- 单文件可执行程序编译成功，体积合理（含 ECharts 约 2-3MB）
- 启动 < 2 秒，浏览器自动打开
- 页面为现代中文仪表盘风格，包含 CSV 上传入口
- 前端资源全部嵌入，无外部依赖
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-csv-pipeline/01-01-SUMMARY.md`
</output>
